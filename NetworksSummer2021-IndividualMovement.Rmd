---
title: "Individual Movement Analysis"
author: "Matina Donaldson-Matasci"
date: "10/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(ggplot2)
theme_set(theme_minimal())
require(dplyr)
require(tidyr)
require(ggthemes)
require(grDevices)
require(lme4)
```

## Hypotheses / Questions
We would like to discover the rules by which individual turtle ants move through a branching structure.

1. Are they more likely to take left or right turns?
1. Are they more likely to take a wider, less angled turn or a narrower, more angled turn?
1. Are they more likely to move inwards towards the trunk, or outwards towards the tips?

We also want to understand how these choices at individual junctions produce paths to specific nests.

1. Which nests are they most likely to visit?
1. Which nests do they reach most quickly?

## Data description

We created a branching structure for the ants to navigate, consisting of a series of many Y-junctions. Each Y-junction has a thicker, main branch leading back to the trunk, and two alternate choices, one of which has a small angle of deviation (10 degrees) and the same diameter as the main branch, and the other of which has a large angle of deviation (70 degrees) and a smaller diameter.

First, given a table of the junction labels and their connections to one another, we would like to construct a table of the different types of turns an ant can take. 

Here is the table of junction entry/exit points, which we will call branches. We are only interested in the columns "Junction" (the junction label), "Direction" (whether it is the main, left or right branch), "Width" (the diameter of the branch) and "Leads.to.Node" (which node the branch leads to). We check to see that it has the right shape: we expect 31 junctions, each of which has a main, left and right branch. So there are 93 rows, one row for each branch of each junction. There are 4 different branch diameters. Most junctions have two different branch widths, but there is one junction that has only 1. 

```{r}
branches <- read.csv("data/NetworksSummer2021-JunctionReference.csv",
                     colClasses=c("Junction"="character","Direction"="factor",
                                  "Width"="numeric", "Leads.to.Node"="character"),
                     na.strings="")
branches <- branches %>%
  select(Junction, Direction, Width, Leads.to.Node)
head(branches)
branches %>% summarize(num_junctions=n_distinct(Junction))
branches %>% group_by(Junction) %>% summarize(num_branches=n())
branches %>% group_by(Width) %>% summarize(num_branches=n())
branches %>% group_by(Junction) %>% summarize(num_widths=n_distinct(Width))
```

Now we want to create a table of turns. This consists of a sequence of two things: entering a junction from one branch, and exiting it along (potentially) another branch That is, for each junction, we want all combinations of branches. To do this, we use a full join, based on the junction. For each turn, we then specify whether it is a left turn or a right turn, based on the entry and exit direction.

This action is then carried out with narrow and wide junction decisions as well.

```{r}
branches <- branches %>%
  group_by(Junction) %>%
  mutate(Rel.Width = if_else(Width > min(Width),"wide","narrow")) %>%
  ungroup()

turns <- full_join(branches,branches,by=c("Junction"),suffix=c(".From",".To")) %>%
  rename(Node.From=Leads.to.Node.From, Node.To=Leads.to.Node.To)
turns <- turns %>%
  mutate(Turn.Type = factor(case_when(
    Direction.From=="main" & Direction.To=="left" ~ "L",
    Direction.From=="main" & Direction.To=="right" ~ "R",
    Direction.From=="left" & Direction.To=="right" ~ "L",
    Direction.From=="left" & Direction.To=="main" ~ "R",
    Direction.From=="right" & Direction.To=="main" ~ "L",
    Direction.From=="right" & Direction.To=="left" ~ "R",
    TRUE ~ "U"
  )))

turns <- turns %>%
  mutate(Turn.Width = if_else(Node.From == Node.To, NA_character_,case_when(
    Rel.Width.From=="wide" & Rel.Width.To=="narrow" ~ "N",
    Rel.Width.From=="wide" & Rel.Width.To=="wide" ~ "W")))

turns <- turns %>%
  mutate(Turn.Trunk = if_else(Direction.From == Direction.To, NA_character_,case_when(
    Direction.From=="left" & Direction.To=="main" ~ "to.trunk",
    Direction.From=="right" & Direction.To=="main" ~ "to.trunk",
    Direction.From=="main" & Direction.To=="left" ~ "away.from.trunk",
    Direction.From=="main" & Direction.To=="right" ~ "away.from.trunk",
    Direction.From=="left" & Direction.To=="right" ~ "away.from.trunk",
    Direction.From=="right" & Direction.To=="left" ~ "away.from.trunk"
  )))

```

Finally, we want to join our data on individual movement between junctions with this data describing the types of turns. To do this, first we need to fill in some missing information: where the ant came from, and where it's going. We begin with information about the sequence of junctions visited ("Junction"). This is typically sufficient to reconstruct the whole trajectory: the ant came from the previous junction in the list, and went towards to next junction in the list. However, if the ant made a U-turn along a branch, we have an exception: the ant actually never reached the node it was going towards when it first exited the junction, which is also the node it was traveling from when it reenters the same junction again. In this case, we recorded the junction it was traveling towards in the column ("Exited Toward").

```{r}
movement <- read.csv("data/NetworksSummer2021-IndividualMovement.csv",
                     colClasses="character", na.strings="")
movement <- movement %>%
  select(Date, Colony, Ant.ID, Time, Junction, 
         Entered.From, Exited.Toward, Action..inspect.ignore.) %>%
  mutate(Colony=factor(Colony),Ant.ID=factor(Ant.ID)) %>%
  group_by(Colony,Ant.ID) %>%
  # Ants come in pairs, labeled e.g. as 1A and 1B
  # We want to be able to distinguish the first ant (A) 
  # from the second (B) in each pair
  separate(Ant.ID, into=c("Pair.ID","Ant.In.Pair"), 
           sep=1, remove=F, convert=F) %>%
  mutate(Pair.ID=as.factor(Pair.ID),
         Ant.In.Pair=as.factor(Ant.In.Pair)) %>%
  # Here we count up how many times an ant has inspected food
  # or a nest so we can distinguish outgoing & returning paths
  mutate(Inspect=if_else(grepl("inspect",
                               Action..inspect.ignore.),T,F)) %>%
  mutate(Num.Inspections=cumsum(Inspect)) %>%
  # Here we infer the direction an ant came from by 
  # the prior junction it visited and where it went by the
  # next junction it visited, unless that information was given
  # in the Exited.Toward column
  mutate(Node.From=lag(Junction),Node.To=lead(Junction)) %>%
  mutate(Node.From=replace_na(Node.From,-1)) %>% 
  mutate(Node.To=if_else(is.na(Exited.Toward),Node.To,Exited.Toward)) %>%
  mutate(Node.To=replace_na(Node.To,-1)) %>% 
  mutate(Entered.From=lag(Exited.Toward))  %>%
  mutate(Node.From=if_else(is.na(Entered.From),Node.From,Entered.From))
```

Now, finally, we should be able to join the two tables together to generate a list of all the turns made by each ant.

```{r}
turn_choices <- left_join(movement,turns,by=c("Junction","Node.From","Node.To")) %>%
  filter(Junction %in% unique(branches$Junction))
write.csv(turn_choices,file="data/NetworksSummer2021-TurnChoices.csv")
```

Besides the turns they made at each junction, we also want to analyze which tips (ends of branches, containing food or nests) they reached. To figure this out, we look for visits to junctions with labels that are in our list of tips. For each such visit, we ask how many nodes they passed along the way since the start (a measure of path length).

```{r}
tips <- read.csv("data/NetworksSummer2021-TipReference.csv",
                 colClasses=c("Tip"="character","Type"="factor"),
                 na.strings="")

movement <- movement %>%
  group_by(Colony,Ant.ID) %>%
  mutate(Num.Nodes.Passed=row_number())

tip_visits <- inner_join(movement,tips,by=c("Junction"="Tip")) 

write.csv(tip_visits,file="data/NetworksSummer2021-TipVisits.csv")
```

## Data analysis

### Are they more likely to take left or right turns?

Let's make a plot showing each ant's left vs. right turns. We want to include only turns on the way to a nest or food, because if we include both directions any initial bias while searching might be canceled out by the ant making its way back. We also want to include only the first ant in the pair, because the second ant may be influenced by the first ant's choices. If there is no bias, we expect a regression line of the number of right turns on the total number of turns (left or right) to have a slope of 1/2 (we want to force it to have an intercept of 0).

```{r}
turn_choices_by_ant <- turn_choices %>% 
  group_by(Colony,Ant.ID) %>%
  filter(Num.Inspections==0) %>%
  filter(Ant.In.Pair=="A") %>%
  summarize(num_turns=n(), 
            left_turns=sum(Turn.Type=="L",na.rm=T), 
            right_turns=sum(Turn.Type=="R",na.rm=T), 
            total_turns=right_turns+left_turns) %>%
  ungroup()

right.model <- lm(right_turns ~ total_turns + 0,
                  data=turn_choices_by_ant)
no.bias.model <- lm(right_turns ~ offset(0.5*total_turns)+0, 
                    data=turn_choices_by_ant)
summary(right.model)
anova(right.model,no.bias.model)
```

Comparing the fitted model with a model of known slope (=0.5) shows that the outgoing ants do have a slight right bias, with a 59.5% chance of turning right. Here is a plot to illustrate it:

```{r}
max_turns <- max(turn_choices_by_ant$total_turns)
ggplot(turn_choices_by_ant, aes(x=total_turns,y=right_turns)) + 
  geom_point(aes(color=Colony)) + 
  geom_smooth(method="lm", formula=y ~ x + 0, color="black") +
  geom_abline(slope=0.5,intercept=0,lty=2) + 
  xlab("Total number of turns") + ylab("Number of right turns") +
  xlim(0,max_turns) +
  theme_minimal(base_size = 25)
ggsave("images/RightvsTotalTurns.png", 
       dpi=300, width = 8, height = 5, units = "in")
```

How often do they U-turn at a junction? Approximately 9.5% of the time.

```{r}
table(turn_choices$Turn.Type)/sum(table(turn_choices$Turn.Type))
```

In particular, we would like to know which way they turn at the first junction they meet. We'll again just look at the first ant in each pair, and only at their first choice when they arrive at the junction.

```{r}
first_turns <- turn_choices %>% 
  filter(Junction=="0",Direction.From=="right",
         Direction.To %in% c("main","left")) %>% 
  filter(Ant.In.Pair=="A") %>% 
  group_by(Colony,Ant.ID) %>% 
  summarize(Turn.Type=first(Turn.Type)) %>% 
  group_by(Turn.Type) %>% 
  summarize(num=n())
first_turns

binom.test(first_turns$num)
```

This shows something of a left bias at that first junction: 19 out of 31 turns were to the left. This seems contrary to the general right bias and suggests that the right bias could be affected (or even produced) by branching geometry. However, the proportion of left turns is not significantly different from 50%.

### Which nests are they most likely to visit?

Of the eight different nests, which one are the ants most likely to visit first? We filter out only visits to nests, and then take the first one for each ant. The plot shows that many ants visited nest 72 first, closely followed by 321.

```{r}


first_nest_visits <- tip_visits %>%
  filter(Type=="nest") %>%
  group_by(Colony,Ant.ID) %>%
  summarize(Junction=first(Junction),Num.Nodes.Passed=first(Num.Nodes.Passed))

first_nest_visits <- first_nest_visits %>%
  mutate(Nest=factor(Junction,
                  levels=c("321","72","1112","1221","412",
                           "82","2112","2212")))
nest.palette <- palette.colors(n = 9, palette = "Classic Tableau")[c(1:7,9)]
ggplot(first_nest_visits, aes(x=Nest,fill=Nest)) + 
  geom_bar() + ylim(0,14) +
  scale_fill_manual(values=nest.palette,drop=F) +
  scale_x_discrete(drop=F) +
  #scale_fill_tableau(palette = "Tableau 10") +
  xlab("Nest Number") + 
  ylab("Number of ants reaching this nest first") +
  theme(legend.position="none")
ggsave("images/FirstNestVisits-NumAnts.png", 
       dpi=300, width = 5, height = 3, units = "in")
```

Here is another version of the same graph with different labeling for the poster.

```{r}
first_nest_visits_POSTER <- first_nest_visits %>%
  mutate(Poster.Nest= case_when(
    Nest == 321 ~ "A2",
    Nest == 72 ~ "B3",
    Nest == 1112 ~ "C1",
    Nest == 1221 ~ "D2",
    Nest == 412 ~ "E1",
    Nest == 82 ~ "F1",
    Nest == 2112 ~ "G1",
    Nest == 2212 ~ "H1"
  ))

nest.palette <- palette.colors(n = 9, palette = "Classic Tableau")[c(1:7,9)]
ggplot(first_nest_visits_POSTER, aes(x=Poster.Nest,fill=Poster.Nest)) + 
  geom_bar() + ylim(0,14) +
  scale_fill_manual(values=nest.palette,drop=F) +
  scale_x_discrete(drop=F) +
  #scale_fill_tableau(palette = "Tableau 10") +
  xlab("Nest Name") + 
  ylab("First nest visits") +
  labs(title = "Nest Discovery (Individual)") +
  theme_minimal(base_size = 25) +
  theme(legend.position="none")
ggsave("images/FirstNestVisits-NumAnts-POSTER.png", 
       dpi=300, width = 8, height = 5, units = "in")
```

We also would like to know how direct their route to get there was. If they take a direct route, this will be easier to reinforce with pheromone. To figure this out, we plot the number of nodes each ant passed along the way to the first nest they visited. The shortest possible path is 6 nodes long, because that is the distance from the entry point to each tip.

```{r}
ggplot(first_nest_visits, aes(x=Nest,
                              y=Num.Nodes.Passed)) + 
  geom_boxplot(aes(fill=Nest)) + 
  geom_jitter(height=0,width=0.15) +
  scale_fill_manual(values=nest.palette,drop=F) +
  #scale_color_manual(values=palette.colors(n = 8, palette = "Classic Tableau")) +
  scale_x_discrete(drop=F) +
  #scale_color_tableau(palette = "Tableau 10") +
  #scale_fill_tableau(palette = "Tableau 10") +
  geom_abline(slope=0,intercept=6,lty=2) +
  xlab("Nest Number") + ylab("Path length (number of nodes)")  +
  theme(legend.position="none")
ggsave("images/FirstNestVisits-PathLength.png", 
       dpi=300, width = 5, height = 3, units = "in")
```

Here we see that again nest 72 has the most direct routes; in fact there are several ants that went directly there -- something that never happened for any other nest.

### Are they more likely to go on wide branches?

We can also inspect whether they prefer wider branches when exploring. At some decisions the ants need to decide between wide and narrow branches, but not many, since U-turns do not count as a wide bias, and ants coming from a narrow branch have equal width in front of them.

```{r}
turn_choices_by_ant_width <- turn_choices %>% 
  group_by(Colony,Ant.ID) %>%
  filter(Num.Inspections==0) %>%
  filter(Ant.In.Pair=="A") %>%
  summarize(num_turns=n(), 
            narrow_turns=sum(Turn.Width=="N",na.rm=T), 
            wide_turns=sum(Turn.Width=="W",na.rm=T), 
            total_width_turns=narrow_turns+wide_turns) %>%
  ungroup()

wide.model <- lm(wide_turns ~ total_width_turns + 0,
                  data=turn_choices_by_ant_width)
no.bias.model <- lm(wide_turns ~ offset(0.5*total_width_turns)+0, 
                    data=turn_choices_by_ant_width)
summary(wide.model)
anova(wide.model,no.bias.model)
```

Comparing the fitted model with a model of known slope (=0.5) shows that outgoing ants have a significant wide bias, staying on the wide branch 63.2% of the time where width could be considered. This plot illustrates this:

```{r}
max_turns <- max(turn_choices_by_ant_width$total_width_turns)
ggplot(turn_choices_by_ant_width, aes(x=total_width_turns,y=wide_turns)) + 
  geom_point(aes(color=Colony)) + 
  geom_smooth(method="lm", formula=y ~ x + 0, color="black") +
  geom_abline(slope=0.5,intercept=0,lty=2) + 
  xlab("Total number of turns") + ylab("Number of wide turns") +
  xlim(0,max_turns) +
  theme_minimal(base_size = 25)
ggsave("images/WidevsTotalTurns.png", 
       dpi=300, width = 8, height = 5, units = "in")
```

### Are they more likely to travel toward or away from the trunk?
Are ants generally more likely to move toward or away from the trunk? How does this tendency change after they have inspected something at a tip?

Analysis including ant choices both before and after inspection, without differentiating between the two.
```{r}
turn_choices_by_ant_trunk <- turn_choices %>% 
  group_by(Colony,Ant.ID) %>%
  #filter(Num.Inspections==0) %>% Unlike with the past analyses, we don't want 
  # to filter out the decisions made after inspection.
  filter(Ant.In.Pair=="A") %>% # Still do filter out the second ant in the pair 
  #because it might be influenced by the first
  filter(Direction.From!="main") %>% #also only include turns where ant has choice between toward and away, 
  # not ones where it's away either way (i.e. turning from main)
  summarize(num_turns=n(), 
            turns_to_trunk=sum(Turn.Trunk=="to.trunk",na.rm=T), 
            turns_away_from_trunk=sum(Turn.Trunk=="away.from.trunk",na.rm=T), 
            total_turns=turns_to_trunk+turns_away_from_trunk) %>%
  ungroup()

trunk.model <- lm(turns_to_trunk ~ total_turns + 0,
                  data=turn_choices_by_ant_trunk)
no.bias.model <- lm(turns_to_trunk ~ offset(0.5*total_turns)+0, 
                    data=turn_choices_by_ant_trunk)
summary(trunk.model)
anova(trunk.model,no.bias.model)
```
Like when analyzing left vs right or wide vs narrow turns the ants made, the no bias model is that the ants have a 50:50 chance of picking either option between "to trunk" or "away from trunk" (if we only consider turns that present a choice between toward and away). It appears that ants turn toward the trunk about 59.897% of the time overall.

How does the likelihood of moving toward the trunk differ before and after an ant has inspected? (e.g. do ants tend to go to the trunk after inspecting at a tip?)
```{r}
# group turn_choices by whether Num.Inspections is 0 or not
# for the two categories, do ANOVA separately.
turn_choices_trunk_before_inspect <- turn_choices %>% 
  group_by(Colony,Ant.ID) %>%
  filter(Num.Inspections==0) %>% # ant has not inspected yet
  filter(Ant.In.Pair=="A") %>% 
  filter(Direction.From!="main") %>%
  summarize(num_turns=n(), 
            turns_to_trunk=sum(Turn.Trunk=="to.trunk",na.rm=T), 
            turns_away_from_trunk=sum(Turn.Trunk=="away.from.trunk",na.rm=T), 
            total_turns=turns_to_trunk+turns_away_from_trunk) %>%
  ungroup()

trunk.model <- lm(turns_to_trunk ~ total_turns + 0,
                  data=turn_choices_trunk_before_inspect)
no.bias.model <- lm(turns_to_trunk ~ offset(0.5*total_turns)+0, 
                    data=turn_choices_trunk_before_inspect)
summary(trunk.model)
anova(trunk.model,no.bias.model)
```

```{r}
turn_choices_trunk_after_inspect <- turn_choices %>% 
  group_by(Colony,Ant.ID) %>%
  filter(Num.Inspections!=0) %>% # ant has already inspected
  filter(Ant.In.Pair=="A") %>% 
  filter(Direction.From!="main") %>%
  summarize(num_turns=n(), 
            turns_to_trunk=sum(Turn.Trunk=="to.trunk",na.rm=T), 
            turns_away_from_trunk=sum(Turn.Trunk=="away.from.trunk",na.rm=T), 
            total_turns=turns_to_trunk+turns_away_from_trunk) %>%
  ungroup()

trunk.model <- lm(turns_to_trunk ~ total_turns + 0,
                  data=turn_choices_trunk_after_inspect)
no.bias.model <- lm(turns_to_trunk ~ offset(0.5*total_turns)+0, 
                    data=turn_choices_trunk_after_inspect)
summary(trunk.model)
anova(trunk.model,no.bias.model)
```
Before inspecting, the ants have at 61.162% chance of turning toward the trunk. After inspecting, that chance is 59.320%. I could do a statistical test to determine whether this difference in proportions is significant, but that's not the focus here. I could also distinguish between number of inspections done and do ANOVA based on that, but I'm not sure whether that's useful to know or not.

Visualizing the data on turn choices toward/away from trunk overall (adapting code used to visualize the likelihood of right turns):
```{r}
max_turns_trunk <- max(turn_choices_by_ant_trunk$total_turns)
ggplot(turn_choices_by_ant_trunk, aes(x=total_turns,y=turns_to_trunk)) + 
  geom_point(aes(color=Colony)) + 
  geom_smooth(method="lm", formula=y ~ x + 0, color="black") +
  geom_abline(slope=0.5,intercept=0,lty=2) + 
  xlab("Total number of turns") + ylab("Number of turns to trunk") +
  xlim(0,max_turns_trunk) +
  theme_minimal(base_size = 25)
ggsave("images/ToTrunkvsTotalTurns.png", 
       dpi=300, width = 8, height = 5, units = "in")
```


### Examining sequences of turns
If an ant turns [left/right/U-turn], what is the likelihood that the next turn will be [left/right/U-turn]?
e.g. How often is a right turn followed by a left turn? By a right turn? By a U-turn?
```{r}
turn_choices_seq <- turn_choices %>%
  group_by(Colony,Ant.ID) %>%
  filter(Num.Inspections==0) %>%
  filter(Ant.In.Pair=="A") %>% 
  mutate(Next.Turn.Type = lead(Turn.Type)) %>%
  #mutate(Turn.Seq.Pair = ifelse(is.na(Next.Turn.Type), NA, paste(Turn.Type, Next.Turn.Type))) %>%
  ungroup()

#split_Turn.Seq.Pair <- strsplit(turn_choices_seq$Turn.Seq.Pair, " ")

# Summary:
num_of_turn1_then_turn2 <- turn_choices_seq %>%
  group_by(Turn.Type, Next.Turn.Type) %>%
  filter(is.na(Turn.Type) == FALSE & is.na(Next.Turn.Type) == FALSE) %>%
  summarize(n_turn1_then_turn2=n())

num_of_turn1 <- turn_choices_seq %>%
  group_by(Turn.Type) %>%
  filter(is.na(Turn.Type) == FALSE & is.na(Next.Turn.Type) == FALSE) %>%
  summarize(n_turn1=n()) 

turn_choices_seq_summary <- left_join(num_of_turn1_then_turn2, num_of_turn1, by=c("Turn.Type")) %>%
  group_by(Turn.Type, Next.Turn.Type) %>%
  summarize(n=n_turn1_then_turn2, prop_turn1_then_turn2 = n_turn1_then_turn2/n_turn1)
# Proportions are calculated relative to the number of turns that started with the
# given direction, e.g. for (L, L) you would do 97/(97+74+23)

turn_choices_seq_summary

# Will we want to exclude U-turns from analysis?
```
When an ant turns one direction, the next turn is more likely to be in that same direction than in the opposite direction (i.e. 50% chance to follow a L turn with L, 38% chance to follow L turn with R; 60% to follow R turn with R, 25% to follow R turn with L). After a U-turn, an ant is slightly more likely to turn right than left, and will very rarely follow a U-turn with a U-turn.

Visualization:
```{r}
ggplot(turn_choices_seq_summary, aes(x=Turn.Type, y=prop_turn1_then_turn2)) + 
  geom_col(aes(fill = Next.Turn.Type)) +
  xlab("First turn type") +
  ylab("Proportion of next turn type")

ggsave("images/SequentialTurnTypeDecisions.png", 
       dpi=300, width = 8, height = 5, units = "in")
```


Seeing the data above, I realized that U-turns make up a substantial proportion of ant turns. If an ant is more likely to make a U-turn after a certain type of turn, that could introduce additional bias into the data. I'd like to determine the strength of the bias and also look at the data with U-turns excluded.

If an ant turns [toward/away from] the trunk, what is the likelihood of a [R/L/U] turn?
```{r}
#still using turn_choices_seq because the data we need for this question is all in turn_choices_seq

# Summary:
num_of_turn1_then_turn2 <- turn_choices_seq %>%
  group_by(Turn.Trunk, Next.Turn.Type) %>%
  filter(is.na(Turn.Trunk) == FALSE & is.na(Next.Turn.Type) == FALSE) %>%
  summarize(n_turn1_then_turn2=n())

num_of_turn1 <- turn_choices_seq %>%
  group_by(Turn.Trunk) %>%
  filter(is.na(Turn.Trunk) == FALSE & is.na(Next.Turn.Type) == FALSE) %>%
  summarize(n_turn1=n()) 

turn_choices_trunk_then_type_summary <- left_join(num_of_turn1_then_turn2, num_of_turn1, by=c("Turn.Trunk")) %>%
  group_by(Turn.Trunk, Next.Turn.Type) %>%
  summarize(n=n_turn1_then_turn2, prop_turn1_then_turn2 = n_turn1_then_turn2/n_turn1)

turn_choices_trunk_then_type_summary
```
Regarding the main point of doing this analysis: ants have roughly the same likelihood of making a U-turn next regardless of whether their previous turn was away from or toward the trunk. Therefore, U-turns don't contribute to creating the bias for moving toward the trunk (e.g. it is not the case that ants moving away from the trunk are that much more likely to U-turn and therefore move toward the trunk). Curiously, the chance of moving right is much higher than the chance of moving left, which may or may not actually be consistent with the right turn bias observed earlier (as that previous analysis was done excluding U-turns).

Visualization:
```{r}
ggplot(turn_choices_trunk_then_type_summary, aes(x=Turn.Trunk, y=prop_turn1_then_turn2)) + 
  geom_col(aes(fill = Next.Turn.Type)) +
  xlab("First turn type") +
  ylab("Proportion of next turn type")
  
ggsave("images/SequentialTurnTypeDecisionsTrunkToType.png", 
       dpi=300, width = 8, height = 5, units = "in")
```

Why, then, do ants tend to end up at nest 72 rather than at nest 82? It is shown above that the first turn the ants take has a slightly greater chance to be to the left rather than to the right. Nest 72 is to the left while nest 82 is to the right. However, the difference in preference for starting left/right is not great enough on its own to explain the great preference for 72 over 82. We also know that once an ant starts down a path, the likelihood of U-turning (which changes the path the ant takes) is equally likely regardless of whether the ant is moving toward or away from the trunk.

I also want to look at how likely it is for an ant to turn from a wide branch to a narrow branch (or vice versa, or staying on a branch of the same width) when turning toward the trunk or away from the trunk. This tells us whether an ant's preference to go further out onto limbs differs based on whether it's moving toward or away from the trunk. That is something that could affect which nests the ant ends up at.
```{r}
# Will need to make a new dataframe rather than reusing turn_choices_seq 
# because I need to mutate in a new variable for the next value of Turn.Width

turn_choices_seq_width <- turn_choices %>%
  group_by(Colony,Ant.ID) %>%
  filter(Num.Inspections==0) %>%
  filter(Ant.In.Pair=="A") %>% 
  mutate(Next.Turn.Width = lead(Turn.Width)) %>%
  ungroup()

# Summary:
num_of_turn1_then_turn2 <- turn_choices_seq_width %>%
  group_by(Turn.Trunk, Next.Turn.Width) %>%
  filter(is.na(Turn.Trunk) == FALSE & is.na(Next.Turn.Width) == FALSE) %>%
  summarize(n_turn1_then_turn2=n())

num_of_turn1 <- turn_choices_seq_width %>%
  group_by(Turn.Trunk) %>%
  filter(is.na(Turn.Trunk) == FALSE & is.na(Next.Turn.Width) == FALSE) %>%
  summarize(n_turn1=n()) 

turn_choices_seq_width_summary <- left_join(num_of_turn1_then_turn2, num_of_turn1, by=c("Turn.Trunk")) %>%
  group_by(Turn.Trunk, Next.Turn.Width) %>%
  summarize(n=n_turn1_then_turn2, prop_turn1_then_turn2 = n_turn1_then_turn2/n_turn1)

turn_choices_seq_width_summary

```
It seems that when ants are moving away from the trunk, there is an even greater preference for turning onto wider branches than when ants are moving toward the trunk. In most cases, as ants move to nests they must make the choice to turn onto narrower branches. Because ants moving away from the trunk prefer to turn onto wider branches, this could contribute to decreased nest visits for nests to the right of the entry point (in the visual where the trunk is to the left). It could also deter ants from visiting nests that require three separate instances of choosing the narrower branch (moving from widths of 0.60 to 0.45 to 0.34 to 0.25, e.g. nests 1112 and 2212 if I'm not mistaken). However, nest 82 can be reached without turning onto narrower branches, and yet it is visited very little.  
Now that I think about it, though, this analysis is flawed. When moving toward the trunk, there are more routes that involve moving from narrow to wide branches, e.g moving from a tip to a wider branch and then to the main (thickest) branch. On the other hand, moving away from the trunk involves moving from wider to narrower branches. I will exclude this analysis from my presentation.

### Do ants have a turning angle bias?

We would like to know whether ants choose which direction to turn based on the turning angle. In particular, we hypothesize that they prefer a shallower (less deviating) turn at an asymmetric Y-shaped junction. 

To determine this, we will ask whether ants tend to take the sharper (more deviating) or shallower (less deviating) turn, and whether any observed preference depends on:

1. Whether the sharper turn is on the left side or the right side

1. The direction the ant approaches the junction from: the main branch (main), the thinner more angled offshoot (sharp), or the thicker less angled offshoot (shallow)

To do this, we'll need to introduce some new variables to describe the junctions and the turns at each junction. First of all, we classify each junction as a left-handed one (with the sharp offshoot to the left) or a right-handed one (with the sharp offshoot to the right).

```{r}
junction_type <- branches %>%
  filter(Rel.Width=="narrow") %>%
  mutate(Handedness_raw = case_when(
    Direction=="left" ~ "LH", #left-handed junction
    Direction=="right" ~ "RH", #right-handed junction
    Junction == 111 ~ "RH", #can't tell from width, but it's RH
    Junction == 221 ~ "LH" # can't tell from width, but it's LH
  )) %>%
  group_by(Junction) %>%
  summarize(Junction.Handedness = 
              names(which.max(table(Handedness_raw)))) %>%
  mutate(Junction.Handedness=factor(Junction.Handedness))
```

This produces a table of junction ID number and handedness. The two special cases where both offshoots are narrow could be excluded from our model but they do have a handedness, which cannot be extracted by analyzing narrow/wideness.

Now we can create a new way to classify each turn (`Turn.Angle`), as "sharp" or "shallow", according to how the ant entered the junction (`Direction.From`: "main", "left", "right") and the handedness of that junction (`Junction.Handedness`: "LH", "RH"). For example, if the ant enters from "main", and turns left on a left-handed junction, that means it has taken the sharper turn.

We also classify the direction it has come from (`Angle.From`) according to the angle, so for example an ant coming from the left branch on a left-handed junction is coming from the "sharp" direction (the more-angled offshoot), while an ant coming from the left branch on a right-handed junction is coming from the "shallow" direction (the less-angled offshoot).

Finally, we determine whether the sharper turn is on the left side or the right side (`sharpIsLeft`), which depends on whether it is a left or right-handed junctions, and which branch the ant is coming from.

```{r}
turns <- turns %>%
  left_join(junction_type, by="Junction") 

turns <- turns %>%
  mutate(
    Turn.Angle = case_when(
      Direction.From=='main' & Turn.Type=='L' & Junction.Handedness=="LH" ~ "sharp",
      Direction.From=='main' & Turn.Type=='R' & Junction.Handedness=="LH" ~ "shallow",
      Direction.From=='main' & Turn.Type=='L' & Junction.Handedness=="RH" ~ "shallow",
      Direction.From=='main' & Turn.Type=='R' & Junction.Handedness=="RH" ~ "sharp",
      Direction.From=='left' & Turn.Type=='L' ~ "sharp",
      Direction.From=='left' & Turn.Type=='R' ~ "shallow",
      Direction.From=='right' & Turn.Type=='L' ~ "shallow",
      Direction.From=='right' & Turn.Type=='R' ~ "sharp"),
      #Junction==111 & Turn.Type=='L' ~ "shallow",
      #Junction==111 & Turn.Type=='R' ~ "sharp",
      #Junction==221 & Turn.Type=='L' ~ "sharp",
      #Junction==221 & Turn.Type=='R' ~ "shallow")) %>%
    isSharpTurn = Turn.Angle == "sharp",
    sharpIsLeft = case_when(
      Direction.From=='main' & Junction.Handedness=="LH" ~ TRUE,
      Direction.From=='left' & Junction.Handedness=="LH" ~ TRUE,
      Direction.From=='left' & Junction.Handedness=="RH" ~ TRUE,
      TRUE ~ FALSE # for all other cases, sharp is not left
    ),
    Angle.From = factor(case_when(
      Direction.From == 'main' ~ "main",
      Direction.From == 'left' & Junction.Handedness == "LH" ~ "sharp",
      Direction.From == 'left' & Junction.Handedness == "RH" ~ "shallow",
      Direction.From == 'right' & Junction.Handedness == "LH" ~ "shallow",
      Direction.From == 'right' & Junction.Handedness == "RH" ~ "sharp"
      # Direction.From == 'left' & Junction == 111 ~ "shallow",
      # Direction.From == 'right' & Junction == 111 ~ "sharp",
      # Direction.From == 'left' & Junction == 221 ~ "sharp",
      # Direction.From == 'right' & Junction == 221 ~ "shallow"
    ))
  )
```

Finally we join the actual turn choices individual ants made (`turn_choices`) with the different types of turns (`turns`), using `Node.From` and `Node.To`. This creates a table of turns taken, including our new columns (`Turn.Angle`, `Junction.Handedness`, `Angle.From`, `sharpIsLeft` and `isSharpTurn`). For this analysis we only use exploratory travel (all turns before the first nest is reached) by the first ant in the pair, and we ignore U-turns.

```{r}
turn_choices_angle <- turn_choices %>%
  left_join(select(
    turns, Node.From, Node.To, Turn.Angle, Angle.From,
    isSharpTurn, sharpIsLeft, Junction.Handedness), 
    by=c("Node.From", "Node.To")) %>%
  filter(Num.Inspections==0,Ant.In.Pair=="A") %>%
  filter(Turn.Type != "U")
```

Now we can analyze the turn choices made. We use logistic regression (a binomial generalized linear mixed effects model) to create a model of whether the ant chooses the shallower or sharper turn at each junction. To begin with we look at the null model, which tells us overall whether the turn choice depends on angle at all.

```{r}
null_model <- glmer(
  isSharpTurn ~ (1|Colony:Ant.ID), 
  family = binomial, turn_choices_angle)
summary(null_model)
```

The fact that the intercept is significantly below zero means that ants are significantly less likely to take the sharper turn than the shallower turn. Now let's see if that bias is influenced by anything else. First we can see whether those sharp turns are more likely to be taken if they are also on the left side.

```{r}
leftright_model <- glmer(
  isSharpTurn ~ sharpIsLeft + (1|Colony:Ant.ID), 
  family = binomial, turn_choices_angle)
summary(leftright_model)
anova(null_model,leftright_model)
```

The answer is yes; if the sharp turn is on the left, it is significantly less likely to be taken. Now let's see whether this depends on the direction it came from (`Angle.From`: the main branch, the sharper-angled offshoot, or the shallower-angled offshoot). We'll construct a series of nested models including the `Angle.From` alone, including `Angle.From` and `sharpIsLeft` as additive effects, and including all combinations of `Angle.From` and `sharpIsLeft`. We can compare models using `anova` (a likelihood ratio test) to see whether a more complex model provides a significantly better fit.

```{r}
# We'll try three successively more complex models
angle_model <- glmer(
  isSharpTurn ~ Angle.From + (1|Colony:Ant.ID), 
  family = binomial, turn_choices_angle)
angle_model_plus <- glmer(
  isSharpTurn ~ Angle.From + sharpIsLeft + (1|Colony:Ant.ID), 
  family = binomial, turn_choices_angle)
angle_model_star <- glmer(
  isSharpTurn ~ Angle.From * sharpIsLeft + (1|Colony:Ant.ID), 
  family = binomial, turn_choices_angle)

# Which model is best?
anova(null_model,angle_model,test="Chisq")
anova(angle_model,angle_model_plus,test="Chisq")
anova(angle_model_plus,angle_model_star,test="Chisq")

summary(angle_model_plus)
```

The best model is the one including both the direction of approach, and whether the sharp turn is on the left side, as independent additive effects on the log-odds ratio. When the ant is approaching the turn from the less-angled offshoot, it is much more likely to continue straight back along the main branch than to turn sharply onto the other offshoot. 

To interpret the model, let's look at the estimates and 95% CI for the coefficients for each fixed effect (which direction the ant is coming from, and whether the sharp turn is on the left). We can also use the model to make predictions for each possible approach.

```{r}
# these confidence intervals are in the log-odds scale
angle.ci <- confint(angle_model_plus,parm="beta_")
angle.ci

# create a small table containing all six types of approaches
approach.types <- turn_choices_angle %>% 
  ungroup() %>% 
  select(Angle.From, Junction.Handedness, Direction.From, sharpIsLeft) %>% 
  distinct() %>%
  arrange(Angle.From, sharpIsLeft)
# use the table to make predictions from the model
approach.types$Predictions <- predict(
  angle_model_plus, newdata=approach.types, 
  re.form=NA, # this says ignore random effects in the predictions
  type="response" # this says convert output to probabilities
)
approach.types
```

# Visualization of real data

Here are a couple of ideas for visualization (not mutually exclusive):

1. Do a plot with all turns (excluding U-turns) on the x axis, and sharp turns on the y axis, broken out into six panels by `Angle.From` and `Junction.Handedness`. Each point represents one junction (node), and you could use colors and/or shapes to distinguish among junctions. The predictions above give you a regression line to plot for each panel.

2. For each of the six combinations of `Angle.From` and `Junction.Handedness`, draw colored arrows (approach, sharp turn, shallow turn) on top of a diagram of the junction, showing the direction of approach and each of the two turns. The width of each arrow should be proportional to the number of ants that approached or turned, summed across all junctions in the category and you can write the actual number next to it or inside it.

```{r}
sjPlot::plot_model(angle_model_plus,
                   show.re.var= TRUE, 
                   pred.labels =c("(Intercept)", "from shallow", "from sharp", "sharp is left"),
                   dv.labels= "test")
```

This is alright but not super intuitive, maybe not work pursuing.


```{r}
turn_choices_angle %>%
  ungroup() %>%
  select(Junction, Junction.Handedness, Direction.From, isSharpTurn) %>%
  group_by(Direction.From, Junction.Handedness, Junction) %>%
  summarize(Total = n(), Sharp = sum(isSharpTurn)) %>%
  ggplot() +
  geom_point(mapping = aes(x = Total, y = Sharp)) +
  geom_abline(slope=0.5,intercept=0,lty=2) +
  facet_grid(rows = vars(Junction.Handedness), cols = vars(Direction.From)) +
  theme_minimal(base_size = 25) +
  labs(title = "Sharp Turns vs Total Turns", y = "Number of Sharp Turns", x = "Number of Total Turns")
ggsave("Angle_Data_Visualization.png")
```

